#!/usr/bin/env bash
set -eo pipefail

echo "---> Dyno Metrics buildpack"

# INPUT ARGUMENTS
platform_dir=$2
env_dir=${platform_dir}/env
layers_dir=$1
plan_path=$3

# PLATFORM DIR
echo "     platform_dir files:"
ls -alR "${platform_dir}" | sed 's/^/       /'

# ENV VARS
echo "     env_dir: ${env_dir}"
echo "     env vars:"
if compgen -G "${env_dir}/*" > /dev/null; then
  for var in ${env_dir}/*; do
    declare "$(basename ${var})=$(<${var})"
  done
fi
export | sed 's/^/       /'

# LAYERS
echo "     layers_dir: ${layers_dir}"

# PLAN
echo "     plan_path: ${plan_path}"
echo "     plan contents:"
cat ${plan_path} | sed 's/^/       /'
echo


BUILDPACK_DIR=$(cd "$(dirname "$0")"; cd ..; pwd)
echo "     buildpack dir: ${BUILDPACK_DIR}"

# Load formating tools
source "$BUILDPACK_DIR/bin/common.sh"

BUILD_DIR=${layers_dir}
echo "     build dir: ${BUILD_DIR}"

# Install the runner
topic "Installing Metrics runner"
mkdir -p "$BUILD_DIR/.profile.d"
cp "$BUILDPACK_DIR/extra/agent.sh" "$BUILD_DIR/.profile.d/"
chmod +x "$BUILD_DIR/.profile.d/agent.sh"

echo "here" > "$BUILD_DIR/.metrics"
echo "here" > "${layers_dir}/.metrics"
echo "${HOME}/.metrics"
echo "here" > "${HOME}/.metrics"


echo "---> Done"
